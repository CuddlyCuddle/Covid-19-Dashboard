---
title: "Covid-19"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(DT)
library(leaflet)
library(rgdal)
library(RColorBrewer)
library(plotly)
library(zoo)
library(scales)
library(shiny)
install.packages("flexdashboard")
install.packages("ggplot2")
```


```{r, include=FALSE}
data <- read.csv('https://covid.ourworldindata.org/data/owid-covid-data.csv', header = T)

```

```{r, echo = F}
cum_dat <- data %>%
  filter(as.Date(date) == max(as.Date(date))) %>%
    select(iso_code,
           Country = location, 
           Population = population, 
           Cases = total_cases,
           Deaths = total_deaths) %>%
  mutate(Mortality = round(Deaths/Cases*100, 3)) %>%
  arrange(desc(Cases))
```

Global Cases
===================================== 

Row
-------------------------------------
### Global
```{r}
valueBox("Covid-19 Analysis")
```

### Confirmed Cases
```{r}
valueBox(cum_dat$Cases[cum_dat$Country == "World"])
```

### Deaths
```{r}
valueBox(cum_dat$Deaths[cum_dat$Country == "World"])
```

### Mortality Rate
```{r}
valueBox(paste(round(cum_dat$Deaths[cum_dat$Country == "World"]/cum_dat$Cases[cum_dat$Country == "World"]*100, 2), "%", sep = ""))
```

Row {.tabset}
-------------------------------------
### New Daily Infections
```{r}
#Creating a Subsetted Dataframe
world_dat <- data %>% 
  filter(location == "World") %>% 
  mutate(date = as.Date(date),
         new_cases_SMA7 = rollmean(new_cases, k = 7, align = "center", fill = NA))

#Creating Plot
fig <- plot_ly(world_dat, 
               x = ~date, 
               y = ~new_cases, 
               type = "bar",
               name = "New Cases"
               )

#Adding Moving Averages
fig <- fig %>% add_trace(y = ~new_cases_SMA7,
                         name = "7-Day Moving Average", 
                         type = "scatter", 
                         mode = "lines", 
                         line = list(color = 'rgb(250, 162, 0)'))
fig <- fig %>% layout(yaxis = list(title = "New Cases"), 
                      xaxis = list(title = "Date")
  
)
fig
```

### Suseptible-Infected-Deaths
```{r}
fig <- plot_ly(world_dat, x = ~date, y = ~population-total_cases, name = "Suseptible", type = 'scatter', mode = 'lines')
fig <- fig %>% add_trace(y = ~total_cases, name = "Infections", type = 'scatter', mode = 'lines')
fig <- fig %>% add_trace(y = ~total_deaths, name = "Deaths", type = 'scatter', mode = 'lines')
fig <- fig %>% layout(xaxis = list(title = "Date"), yaxis = list(title = "Population"))
fig
```

  
### Important Information
  This model is not an accurate representation of the SIR model because there is insufficient data tracking individuals who have recovered from COVID-19: thus, infections is not an accurate representation of current infectious and wil contain both infected and infectious individuals. Where the model calls for $S$ = the number of susceptible individuals, $I$ = the number of infectious individuals, $R$ = individuals who have recovered or have deceased.
  
  In addition, the removed has been replaced with death due to the same reason regarding the data. For more information on the SIR model read the section named additional information.
  
  Please note that this model does not account for changing populations.



Row
-------------------------------------
### Cases by Country

```{r}
# Text Data
cum_dat$hover <- with(cum_dat, paste(Country, '<br>', 
                                     "Cases", Cases, '<br>',
                                     "Deaths", Deaths, 
                                     "<br>", "Mortality", paste(Mortality, "%", sep = "")))
## Plotting Cases accross the world
#Boarder Colors
l <- list(color = toRGB("grey"), width = 0.5)

# specify map projection/options
g <- list(
  showframe = FALSE,
  showcoastlines = FALSE,
  projection = list(type = 'Mercator')
)

fig <- plot_geo(cum_dat)
fig <- fig %>% add_trace(
    z = ~Cases, color = ~Cases, colors = 'Blues', 
    text = ~hover, locations = ~iso_code, marker = list(line = l)
  )
fig <- fig %>% colorbar(title = 'Cases')
fig <- fig %>% layout(autosize = T, 
                      # width = 500, 
                      # height = 500,
                       geo = g)

fig

```


### Table of Cumulative Confirmed Cases, Deaths, and Tests
```{r}
datatable(
  data %>% group_by(location) %>%
  filter(as.Date(date) == max(as.Date(date)), location != "World") %>%
    select(Country = location, 
           Population = population, 
           Cases = total_cases, 
           "Cases Per Million" = total_cases_per_million,
           Deaths = total_deaths, 
           "Deaths Per Million" = total_deaths_per_million) %>%
  mutate("PopulationInfected (%)" = round((Cases/Population)*100, 3),
         "Mortality (%)" = round(Deaths/Cases*100, 3)) %>%
  arrange(desc(Cases))
)
```


Total Cases By Country
===================================== 

Column {.sidebar}
-------------------------------------
```{r}
# Countries input
selectInput("groups", "Select", c("First Ten Countries", "First Twenty Countries", "Top Ten Countries", "Top Twenty Countries", "Random Ten Countries", "All Countries"))
```


Column 
-------------------------------------
### Growth Comparison
```{r}
# Dataset
by_days <- data %>% group_by(location) %>% filter(total_cases >= 1, location != "World") %>%
  mutate(days = as.numeric(-rev(difftime(as.Date(date), max(as.Date(date)), units = "days"))),
         new_cases_SMA7 = rollmean(new_cases, k = 7, align = "center", fill = NA)) %>%
  select(location, total_cases, days, population, new_cases, continent, new_cases_SMA7)
# Rand <-
# Top_Twen <-

```


```{r}
fig <- plot_ly(by_days, x = ~days, y = ~total_cases/population * 100, color = ~location, type = "scatter", mode = "lines")
fig <- layout(fig, yaxis = list(title = "Percent (%) of Total Population Infected"), xaxis = list(title = "Days Since First Case"))
fig
```

 
```{r}
fig <- plot_ly(by_days, x = ~days, y = ~total_cases, color = ~location, type = "scatter", mode = "lines")
fig <- layout(fig, yaxis = list(title = "Total Cases (log)",type = "log"))
fig
```

Growth By Country
===================================== 

Column {.sidebar}
-------------------------------------

```{r}
selectInput("country1", "Select a country", sort(unique(by_days$location)), selected = 'United States')
selectInput("country2", "Add a country", sort(unique(by_days$location)), selected = 'Brazil')
selectInput("country3", "Add a country", sort(unique(by_days$location)), selected = 'India')
```

Column
-------------------------------------
```{r}
plotly::renderPlotly({
  # Input 1
 fig <- plot_ly(by_days[which(by_days$location %in% c(input$country1,input$country2,input$country3)),], 
                x = ~days, 
                y = ~new_cases, 
                color = ~location,
                type = "bar")
 
 fig <- fig %>% add_trace(y = ~new_cases_SMA7, 
                         color = ~location,
                         name = "7-Day Moving Average", 
                         type = "scatter", 
                         mode = "lines")
 fig <- fig %>% layout(xaxis = list(title = "Days Since First Case"), 
                       yaxis = list(title = "Daily New Cases"))
 fig
})


```


Timeline of Cases
===================================== 

Column {.sidebar}
-------------------------------------
```{r}



```


Column 
-------------------------------------
```{r}




```


Additional Information
=====================================
